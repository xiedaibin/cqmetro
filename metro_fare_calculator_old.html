<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è½»è½¨äº¤é€šè´¹ç”¨è®¡ç®—å™¨</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 2.2em;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }

        .input-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
        }

        .station-selector {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .line-select {
            flex: 1;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .station-select {
            flex: 2;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .line-select:focus,
        .station-select:focus {
            border-color: #667eea;
            outline: none;
            box-shadow: 0 0 10px rgba(102, 126, 234, 0.3);
        }

        button {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            cursor: pointer;
            font-weight: bold;
            margin-top: 10px;
            transform: translateY(0);
            transition: all 0.3s ease;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .result {
            margin-top: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            border-radius: 10px;
            color: white;
            font-size: 18px;
            display: none;
            animation: slideIn 0.5s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .pricing-rule {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }

        .pricing-rule h3 {
            margin-top: 0;
            color: #333;
        }

        .route-info {
            background: rgba(255, 255, 255, 0.8);
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            color: #333;
        }

        .line-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 15px;
            color: white;
            font-size: 12px;
            font-weight: bold;
            margin-right: 5px;
        }

        .line-1 {
            background-color: #e74c3c;
        }

        .line-2 {
            background-color: #3498db;
        }

        .line-3 {
            background-color: #f1c40f;
        }

        .selected-station {
            margin-top: 10px;
            padding: 8px 12px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 6px;
            font-size: 14px;
            color: #333;
        }

        .line-color-1 {
            color: #e74c3c;
            font-weight: bold;
        }

        .line-color-2 {
            color: #3498db;
            font-weight: bold;
        }

        .line-color-3 {
            color: #f1c40f;
            font-weight: bold;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>ğŸšŠ è½»è½¨äº¤é€šè´¹ç”¨è®¡ç®—å™¨</h1>

        <div class="pricing-rule">
            <h3>ğŸ’° è®¡ä»·è§„åˆ™</h3>
            <p>æŒ‰ä¹˜åé‡Œç¨‹è®¡ä»·ï¼š0-4km: 2å…ƒ | 4-8km: 3å…ƒ | 8-12km: 4å…ƒ | 12-17km: 5å…ƒ | 17-23km: 6å…ƒ | 23-30km: 7å…ƒ | 30-40km: 8å…ƒ |
                40-55km: 9å…ƒ | 55kmä»¥ä¸Šæ¯å¢åŠ 20kmå¢åŠ 1å…ƒ</p>
        </div>

        <div class="input-group">
            <label for="startLine">ğŸš‰ èµ·å§‹ç«™ç‚¹ï¼š</label>
            <div class="station-selector">
                <select id="startLine" class="line-select" onchange="updateStationList('start')">
                    <option value="">é€‰æ‹©çº¿è·¯</option>
                    <option value="1">1å·çº¿</option>
                    <option value="2">2å·çº¿</option>
                    <option value="3">3å·çº¿</option>
                </select>
                <select id="startStation" class="station-select" disabled>
                    <option value="">è¯·å…ˆé€‰æ‹©çº¿è·¯</option>
                </select>
            </div>
            <div id="startSelected" class="selected-station" style="display: none;"></div>
        </div>

        <div class="input-group">
            <label for="endLine">ğŸ¯ ç›®çš„ç«™ç‚¹ï¼š</label>
            <div class="station-selector">
                <select id="endLine" class="line-select" onchange="updateStationList('end')">
                    <option value="">é€‰æ‹©çº¿è·¯</option>
                    <option value="1">1å·çº¿</option>
                    <option value="2">2å·çº¿</option>
                    <option value="3">3å·çº¿</option>
                </select>
                <select id="endStation" class="station-select" disabled>
                    <option value="">è¯·å…ˆé€‰æ‹©çº¿è·¯</option>
                </select>
            </div>
            <div id="endSelected" class="selected-station" style="display: none;"></div>
        </div>

        <button onclick="calculateFare()">ğŸ” è®¡ç®—è´¹ç”¨</button>

        <div id="result" class="result"></div>
    </div>

    <script>
        
        // 1å·çº¿è·ç¦»æ•°æ®
        const line1Distances = {
            "æœå¤©é—¨": {"å°ä»€å­—": 1.423, "è¾ƒåœºå£": 2.846, "ä¸ƒæ˜Ÿå²—": 4.269, "ä¸¤è·¯å£": 5.692, "é¹…å²­": 7.115, "å¤§åª": 8.538, "çŸ³æ²¹è·¯": 9.961, "æ­‡å°å­": 11.384, "çŸ³æ¡¥é“º": 12.807, "é«˜åº™æ‘": 14.230, "é©¬å®¶å²©": 15.653, "å°é¾™å": 17.076, "æ²™åªå": 18.499, "æ¨å…¬æ¡¥": 19.922, "çƒˆå£«å¢“": 21.345, "ç£å™¨å£": 22.768, "çŸ³äº•å¡": 24.191, "åŒç¢‘": 25.614, "èµ–å®¶æ¡¥": 29.172, "å¾®ç”µå›­": 30.595, "é™ˆå®¶æ¡¥": 32.730, "å¤§å­¦åŸ": 34.438, "å°–é¡¶å¡": 35.861},
            "å°ä»€å­—": {"æœå¤©é—¨": 1.423, "è¾ƒåœºå£": 1.423, "ä¸ƒæ˜Ÿå²—": 2.846, "ä¸¤è·¯å£": 4.269, "é¹…å²­": 5.692, "å¤§åª": 7.115, "çŸ³æ²¹è·¯": 8.538, "æ­‡å°å­": 9.961, "çŸ³æ¡¥é“º": 11.384, "é«˜åº™æ‘": 12.807, "é©¬å®¶å²©": 14.230, "å°é¾™å": 15.653, "æ²™åªå": 17.076, "æ¨å…¬æ¡¥": 18.499, "çƒˆå£«å¢“": 19.922, "ç£å™¨å£": 21.345, "çŸ³äº•å¡": 22.768, "åŒç¢‘": 24.191, "èµ–å®¶æ¡¥": 27.749, "å¾®ç”µå›­": 29.172, "é™ˆå®¶æ¡¥": 31.307, "å¤§å­¦åŸ": 33.015, "å°–é¡¶å¡": 34.438},
            };

        // æ·»åŠ 1å·çº¿ç«™ç‚¹å’Œè¿æ¥
        const line1Stations = Object.keys(line1Distances);

        // 2å·çº¿è·ç¦»æ•°æ®
        const line2Distances = {
            };
        // æ·»åŠ 2å·çº¿ç«™ç‚¹å’Œè¿æ¥
        const line2Stations = Object.keys(line2Distances);
            

        // 3å·çº¿è·ç¦»æ•°æ®
        const line3Distances = {
           };
        // æ·»åŠ 4å·çº¿ç«™ç‚¹å’Œè¿æ¥
        const line3Stations = Object.keys(line3Distances);
            

        // 4 å·çº¿è·ç¦»æ•°æ®
        const line4Distances = {
        };
        // æ·»åŠ 4å·çº¿ç«™ç‚¹å’Œè¿æ¥
        const line4Stations = Object.keys(line4Distances);
            

        // 5 å·çº¿è·ç¦»æ•°æ®
        const line5Distances = {
        };
        // æ·»åŠ 9å·çº¿ç«™ç‚¹å’Œè¿æ¥
        const line5Stations = Object.keys(line5Distances);

        // 9 å·çº¿è·ç¦»æ•°æ®
        const line9Distances = {};

        // æ·»åŠ 9å·çº¿ç«™ç‚¹å’Œè¿æ¥
        const line9Stations = Object.keys(line9Distances);
            

        // 10 å·çº¿è·ç¦»æ•°æ®
        const line10Distances = {
        };
        //10å·çº¿
        const line10Stations = Object.keys(line10Distances);
            

        // 18 å·çº¿å®Œæ•´è·ç¦»æ•°æ®
        const line18Distances = {
        };
        //18å·çº¿
        const line18Stations = Object.keys(line18Distances);
            

        // å›½åšçº¿å®Œæ•´è·ç¦»æ•°æ®
        const linegbxDistances = 
        {
        };
        //å›½åšçº¿å·çº¿
        const linegbxStations = Object.keys(linegbxDistances);
            

        //ç¯çº¿å®Œæ•´æ•°æ®
        const linehuanDistances ={
            };
        //ç¯çº¿
        const linehuanStations = Object.keys(linehuanDistances);
            
        


        

        // å½“å‰é€‰æ‹©çš„ç«™ç‚¹ä¿¡æ¯
        let selectedStations = {
            start: { line: null, station: null },
            end: { line: null, station: null }
        };

        // æ›´æ–°ç«™ç‚¹åˆ—è¡¨
        function updateStationList(type) {
            const lineSelect = document.getElementById(type + 'Line');
            const stationSelect = document.getElementById(type + 'Station');
            const selectedDiv = document.getElementById(type + 'Selected');
            const selectedLine = lineSelect.value;

            if (!selectedLine) {
                stationSelect.innerHTML = '<option value="">è¯·å…ˆé€‰æ‹©çº¿è·¯</option>';
                stationSelect.disabled = true;
                selectedDiv.style.display = 'none';
                selectedStations[type] = { line: null, station: null };
                return;
            }

            // æ¸…ç©ºå¹¶å¯ç”¨ç«™ç‚¹é€‰æ‹©
            stationSelect.innerHTML = '<option value="">è¯·é€‰æ‹©ç«™ç‚¹</option>';
            stationSelect.disabled = false;

            // æ ¹æ®çº¿è·¯å¡«å……ç«™ç‚¹
            let stations;
            if (selectedLine === '1') stations = line1Stations;
            else if (selectedLine === '2') stations = line2Stations;
            else if (selectedLine === '3') stations = line3Stations;
            else stations = [];
            stations.forEach(station => {
                const option = new Option(station, station);
                stationSelect.add(option);
            });

            // æ›´æ–°é€‰æ‹©ä¿¡æ¯
            selectedStations[type].line = selectedLine;
            selectedStations[type].station = null;
            updateSelectedDisplay(type);
        }

        // æ›´æ–°é€‰æ‹©æ˜¾ç¤º
        function updateSelectedDisplay(type) {
            const selectedDiv = document.getElementById(type + 'Selected');
            const selection = selectedStations[type];

            if (selection.line && selection.station) {
                let lineClass = '';
                if (selection.line === '1') lineClass = 'line-color-1';
                else if (selection.line === '2') lineClass = 'line-color-2';
                else if (selection.line === '3') lineClass = 'line-color-3';
                selectedDiv.innerHTML = `å·²é€‰æ‹©ï¼š<span class="${lineClass}">${selection.line}å·çº¿</span> - ${selection.station}`;
                selectedDiv.style.display = 'block';
            } else if (selection.line) {
                let lineClass = '';
                if (selection.line === '1') lineClass = 'line-color-1';
                else if (selection.line === '2') lineClass = 'line-color-2';
                else if (selection.line === '3') lineClass = 'line-color-3';
                selectedDiv.innerHTML = `å·²é€‰æ‹©çº¿è·¯ï¼š<span class="${lineClass}">${selection.line}å·çº¿</span>`;
                selectedDiv.style.display = 'block';
            } else {
                selectedDiv.style.display = 'none';
            }
        }

        // ç«™ç‚¹é€‰æ‹©æ”¹å˜äº‹ä»¶
        document.addEventListener('DOMContentLoaded', function () {
            document.getElementById('startStation').addEventListener('change', function () {
                selectedStations.start.station = this.value;
                updateSelectedDisplay('start');
            });

            document.getElementById('endStation').addEventListener('change', function () {
                selectedStations.end.station = this.value;
                updateSelectedDisplay('end');
            });
        });

        // æ ¹æ®é‡Œç¨‹è®¡ç®—è´¹ç”¨
        function calculatePrice(distance) {
            if (distance <= 4) return 2;
            if (distance <= 8) return 3;
            if (distance <= 12) return 4;
            if (distance <= 17) return 5;
            if (distance <= 23) return 6;
            if (distance <= 30) return 7;
            if (distance <= 40) return 8;
            if (distance <= 55) return 9;

            // 55å…¬é‡Œä»¥ä¸Šï¼Œæ¯å¢åŠ 20å…¬é‡Œå¢åŠ 1å…ƒ
            const extraDistance = distance - 55;
            const extraFare = Math.ceil(extraDistance / 20);
            return 9 + extraFare;
        }

        // è·å–ä¸¤ç«™ä¹‹é—´çš„è·ç¦»
        function getDistance(start, end, line) {
            let distances;
            if (line === '1') distances = line1Distances;
            else if (line === '2') distances = line2Distances;
            else if (line === '3') distances = line3Distances;
            else return null;
            return distances[start] && distances[start][end] ? distances[start][end] : null;
        }

        // æ„å»ºåœ°é“ç½‘ç»œå›¾
        function buildMetroGraph() {
            const graph = {};

            
            addLineToGraph(graph, '1', line1Stations, line1Distances);

            addLineToGraph(graph, '2', line2Stations, line2Distances);

            // æ·»åŠ 3å·çº¿ç«™ç‚¹å’Œè¿æ¥
            addLineToGraph(graph, '3', line3Stations, line3Distances);

            addLineToGraph(graph, '4', line4Stations, line4Distances);

           addLineToGraph(graph, '5', line5Stations, line5Distances);

            addLineToGraph(graph, '6', line6Stations, line6Distances);

            addLineToGraph(graph, '9', line9Stations, line9Distances);

            addLineToGraph(graph, '10', line10Stations, line10Distances); 

            addLineToGraph(graph, '18', line18Stations, line18Distances); 
           
            addLineToGraph(graph, 'å›½åš', linegbxStations, linegbxDistances); 
            
            addLineToGraph(graph, 'ç¯', linehuanStations, linehuanDistances); 

            return graph;
        }

        // å°†å•æ¡çº¿è·¯æ·»åŠ åˆ°å›¾ä¸­
        function addLineToGraph(graph, lineNumber, stations, distances) {
            // ä¸ºæ¯ä¸ªç«™ç‚¹åˆ›å»ºèŠ‚ç‚¹
            stations.forEach(station => {
                const nodeId = `${lineNumber}-${station}`;
                if (!graph[nodeId]) {
                    graph[nodeId] = { station, line: lineNumber, neighbors: {} };
                }
            });

            // æ·»åŠ åŒçº¿è·¯ç«™ç‚¹é—´çš„è¿æ¥
            for (const startStation in distances) {
                const startNodeId = `${lineNumber}-${startStation}`;
                for (const endStation in distances[startStation]) {
                    const endNodeId = `${lineNumber}-${endStation}`;
                    const distance = distances[startStation][endStation];

                    try {
                        // æ·»åŠ åŒå‘è¿æ¥
                        graph[startNodeId].neighbors[endNodeId] = distance;
                        graph[endNodeId].neighbors[startNodeId] = distance;
                    } catch (error) {
                        console.log(`Error while adding connection: ${error}`);
                        console.log(`End node ID: ${endNodeId}`);
                    }
                }
            }
        }

        // æŸ¥æ‰¾æ¢ä¹˜ç«™å¹¶æ·»åŠ è·¨çº¿è¿æ¥
        function addTransferConnections(graph) {
            // æŒ‰ç«™ç‚¹åç§°åˆ†ç»„çš„æ‰€æœ‰èŠ‚ç‚¹
            const stationsByName = {};

            // éå†æ‰€æœ‰èŠ‚ç‚¹ï¼ŒæŒ‰ç«™ç‚¹åç§°åˆ†ç»„
            for (const nodeId in graph) {
                const node = graph[nodeId];
                if (!stationsByName[node.station]) {
                    stationsByName[node.station] = [];
                }
                stationsByName[node.station].push(nodeId);
            }

            // å¯¹äºæœ‰å¤šä¸ªçº¿è·¯ç»è¿‡çš„ç«™ç‚¹ï¼Œæ·»åŠ è·¨çº¿è¿æ¥ï¼ˆæ¢ä¹˜ï¼‰
            for (const stationName in stationsByName) {
                const nodes = stationsByName[stationName];
                if (nodes.length > 1) {
                    // è¯¥ç«™ç‚¹æ˜¯æ¢ä¹˜ç«™
                    for (let i = 0; i < nodes.length; i++) {
                        for (let j = i + 1; j < nodes.length; j++) {
                            const nodeA = nodes[i];
                            const nodeB = nodes[j];

                            // æ·»åŠ é›¶æˆæœ¬çš„æ¢ä¹˜è¿æ¥
                            graph[nodeA].neighbors[nodeB] = 0;
                            graph[nodeB].neighbors[nodeA] = 0;
                        }
                    }
                }
            }
        }

        /**
         * ä¼˜å…ˆé˜Ÿåˆ—ç±»
         * ç”¨äºDijkstraç®—æ³•ä¸­ç¡®ä¿æ€»æ˜¯å¤„ç†è·ç¦»æœ€å°çš„æœªè®¿é—®èŠ‚ç‚¹
         * é€šè¿‡ä¼˜å…ˆçº§æ’åºï¼Œä¿è¯é˜Ÿåˆ—å¤´éƒ¨å§‹ç»ˆæ˜¯ä¼˜å…ˆçº§æœ€é«˜ï¼ˆè·ç¦»æœ€å°ï¼‰çš„å…ƒç´ 
         */
        class PriorityQueue {
            /**
             * æ„é€ å‡½æ•°
             * åˆå§‹åŒ–ä¼˜å…ˆé˜Ÿåˆ—ï¼Œelementsæ•°ç»„å­˜å‚¨é˜Ÿåˆ—å…ƒç´ 
             */
            constructor() {
                this.elements = [];  // å­˜å‚¨é˜Ÿåˆ—å…ƒç´ ï¼Œæ¯ä¸ªå…ƒç´ åŒ…å«nodeIdå’Œpriority
            }

            /**
             * å…¥é˜Ÿæ“ä½œ
             * å°†èŠ‚ç‚¹åŠ å…¥é˜Ÿåˆ—ï¼Œå¹¶æ ¹æ®ä¼˜å…ˆçº§é‡æ–°æ’åº
             * 
             * @param {string} nodeId - èŠ‚ç‚¹ID
             * @param {number} priority - ä¼˜å…ˆçº§ï¼ˆè·ç¦»å€¼ï¼‰
             */
            enqueue(nodeId, priority) {
                // å°†æ–°å…ƒç´ æ·»åŠ åˆ°é˜Ÿåˆ—æœ«å°¾
                this.elements.push({ nodeId, priority });
                // é‡æ–°æ’åºï¼Œç¡®ä¿ä¼˜å…ˆçº§æœ€é«˜çš„å…ƒç´ åœ¨é˜Ÿåˆ—å¤´éƒ¨
                this.sort();
            }

            /**
             * å‡ºé˜Ÿæ“ä½œ
             * å–å‡ºå¹¶è¿”å›é˜Ÿåˆ—å¤´éƒ¨å…ƒç´ ï¼ˆä¼˜å…ˆçº§æœ€é«˜çš„å…ƒç´ ï¼‰
             * 
             * @returns {string} è¿”å›ä¼˜å…ˆçº§æœ€é«˜çš„èŠ‚ç‚¹ID
             */
            dequeue() {
                // å–å‡ºé˜Ÿåˆ—å¤´éƒ¨å…ƒç´ å¹¶è¿”å›å…¶nodeId
                return this.elements.shift().nodeId;
            }

            /**
             * æ£€æŸ¥é˜Ÿåˆ—æ˜¯å¦ä¸ºç©º
             * 
             * @returns {boolean} å¦‚æœé˜Ÿåˆ—ä¸ºç©ºè¿”å›trueï¼Œå¦åˆ™è¿”å›false
             */
            isEmpty() {
                return this.elements.length === 0;
            }

            /**
             * é˜Ÿåˆ—æ’åº
             * æ ¹æ®ä¼˜å…ˆçº§ï¼ˆpriorityï¼‰å¯¹é˜Ÿåˆ—å…ƒç´ è¿›è¡Œå‡åºæ’åº
             * ç¡®ä¿è·ç¦»æœ€å°çš„å…ƒç´ å§‹ç»ˆåœ¨é˜Ÿåˆ—å¤´éƒ¨
             */
            sort() {
                // æŒ‰ä¼˜å…ˆçº§å‡åºæ’åºï¼Œè·ç¦»å°çš„ä¼˜å…ˆçº§é«˜
                this.elements.sort((a, b) => a.priority - b.priority);
            }
        }

        /**
         * Dijkstraæœ€çŸ­è·¯å¾„ç®—æ³•å®ç°
         * ç”¨äºåœ¨åœ°é“ç½‘ç»œä¸­å¯»æ‰¾ä»èµ·ç‚¹åˆ°ç»ˆç‚¹çš„æœ€çŸ­è·¯å¾„
         * 
         * @param {Object} graph - åœ°é“ç½‘ç»œå›¾å¯¹è±¡ï¼ŒåŒ…å«æ‰€æœ‰ç«™ç‚¹å’Œè¿æ¥å…³ç³»
         * @param {string} startLine - èµ·å§‹çº¿è·¯ç¼–å·ï¼ˆå¦‚ '1', '2', '3'ï¼‰
         * @param {string} startStation - èµ·å§‹ç«™ç‚¹åç§°
         * @param {string} endLine - ç›®æ ‡çº¿è·¯ç¼–å·
         * @param {string} endStation - ç›®æ ‡ç«™ç‚¹åç§°
         * @returns {Object|null} è¿”å›è·¯å¾„ä¿¡æ¯å¯¹è±¡ï¼ŒåŒ…å«è·ç¦»ã€è·¯å¾„ã€çº¿è·¯ã€æ¢ä¹˜ç«™ç‚¹å’Œç¥¨ä»·ï¼›å¦‚æœæ— æ³•æ‰¾åˆ°è·¯å¾„åˆ™è¿”å›null
         */
        function dijkstra(graph, startLine, startStation, endLine, endStation) {
            // æ„é€ èµ·å§‹å’Œç›®æ ‡èŠ‚ç‚¹çš„å”¯ä¸€æ ‡è¯†ç¬¦ï¼ˆæ ¼å¼ï¼šçº¿è·¯å·-ç«™ç‚¹åï¼‰
            const startNodeId = `${startLine}-${startStation}`;
            const endNodeId = `${endLine}-${endStation}`;

            // ç‰¹æ®Šæƒ…å†µå¤„ç†ï¼šå¦‚æœèµ·ç‚¹å’Œç»ˆç‚¹ç›¸åŒï¼Œç›´æ¥è¿”å›ç»“æœ
            if (startNodeId === endNodeId) {
                return {
                    distance: 0,           // è·ç¦»ä¸º0
                    route: [startStation],  // è·¯å¾„åªåŒ…å«èµ·å§‹ç«™ç‚¹
                    lines: [startLine],     // åªæ¶‰åŠèµ·å§‹çº¿è·¯
                    transferStations: [],   // æ— æ¢ä¹˜ç«™ç‚¹
                    price: 2               // æœ€ä½ç¥¨ä»·2å…ƒ
                };
            }

            // ========== åˆå§‹åŒ–é˜¶æ®µ ==========
            // distances: å­˜å‚¨ä»èµ·ç‚¹åˆ°æ¯ä¸ªèŠ‚ç‚¹çš„æœ€çŸ­è·ç¦»
            const distances = {};
            // predecessors: å­˜å‚¨æœ€çŸ­è·¯å¾„ä¸­æ¯ä¸ªèŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹ï¼Œç”¨äºè·¯å¾„é‡æ„
            const predecessors = {};
            // visited: æ ‡è®°å·²è®¿é—®çš„èŠ‚ç‚¹ï¼Œé¿å…é‡å¤å¤„ç†
            const visited = {};
            //debugger
            // åˆå§‹åŒ–æ‰€æœ‰èŠ‚ç‚¹çš„è·ç¦»ä¸ºæ— ç©·å¤§
            for (const nodeId in graph) {
                distances[nodeId] = Infinity;
            }
            // èµ·ç‚¹åˆ°è‡ªèº«çš„è·ç¦»ä¸º0
            distances[startNodeId] = 0;

            // åˆ›å»ºä¼˜å…ˆé˜Ÿåˆ—ï¼Œç”¨äºç¡®ä¿æ€»æ˜¯å¤„ç†è·ç¦»æœ€å°çš„æœªè®¿é—®èŠ‚ç‚¹
            const priorityQueue = new PriorityQueue();
            // å°†èµ·ç‚¹åŠ å…¥é˜Ÿåˆ—ï¼Œä¼˜å…ˆçº§ä¸º0
            priorityQueue.enqueue(startNodeId, 0);

            // ========== Dijkstraç®—æ³•ä¸»å¾ªç¯ ==========
            while (!priorityQueue.isEmpty()) {
                // ä»ä¼˜å…ˆé˜Ÿåˆ—ä¸­å–å‡ºè·ç¦»æœ€å°çš„æœªè®¿é—®èŠ‚ç‚¹
                const currentNodeId = priorityQueue.dequeue();

                // å¦‚æœåˆ°è¾¾ç›®æ ‡èŠ‚ç‚¹ï¼Œç»“æŸæœç´¢
                //if (currentNodeId === endNodeId) break;
                // å¦‚æœå½“å‰èŠ‚ç‚¹å·²è®¿é—®è¿‡ï¼Œè·³è¿‡
                if (visited[currentNodeId]) continue;

                // æ ‡è®°å½“å‰èŠ‚ç‚¹ä¸ºå·²è®¿é—®
                visited[currentNodeId] = true;

                // è·å–å½“å‰èŠ‚ç‚¹çš„ä¿¡æ¯
                const currentNode = graph[currentNodeId];
                
                // éå†å½“å‰èŠ‚ç‚¹çš„æ‰€æœ‰é‚»å±…èŠ‚ç‚¹
                for (const neighborId in currentNode.neighbors) {
                    // è·å–åˆ°é‚»å±…èŠ‚ç‚¹çš„è·ç¦»
                    const distance = currentNode.neighbors[neighborId];
                    // è®¡ç®—é€šè¿‡å½“å‰èŠ‚ç‚¹åˆ°è¾¾é‚»å±…èŠ‚ç‚¹çš„æ€»è·ç¦»
                    const totalDistance = distances[currentNodeId] + distance;

                    // æ¾å¼›æ“ä½œï¼šå¦‚æœé€šè¿‡å½“å‰èŠ‚ç‚¹åˆ°è¾¾é‚»å±…çš„è·ç¦»æ›´çŸ­ï¼Œåˆ™æ›´æ–°
                    if (totalDistance < distances[neighborId]) {
                        // æ›´æ–°é‚»å±…èŠ‚ç‚¹çš„æœ€çŸ­è·ç¦»
                        distances[neighborId] = totalDistance;
                        // è®°å½•é‚»å±…èŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹ä¸ºå½“å‰èŠ‚ç‚¹
                        predecessors[neighborId] = currentNodeId;
                        
                        // å°†é‚»å±…èŠ‚ç‚¹åŠ å…¥ä¼˜å…ˆé˜Ÿåˆ—ï¼Œä¼˜å…ˆçº§ä¸ºæ–°çš„è·ç¦»
                        priorityQueue.enqueue(neighborId, totalDistance);
                    }
                }
            }
            

            // ========== è·¯å¾„éªŒè¯å’Œé‡æ„ ==========
            // æ£€æŸ¥æ˜¯å¦æ‰¾åˆ°è·¯å¾„ï¼ˆç›®æ ‡èŠ‚ç‚¹çš„è·ç¦»ä¸æ˜¯æ— ç©·å¤§ï¼‰
            if (distances[endNodeId] === Infinity) {
                return null; // æ— æ³•æ‰¾åˆ°è·¯å¾„
            }
            //console.log("å‰é©±èŠ‚ç‚¹:",predecessors);
            // è°ƒç”¨è·¯å¾„é‡æ„å‡½æ•°ï¼Œè¿”å›å®Œæ•´çš„è·¯å¾„ä¿¡æ¯
            return reconstructPath(graph, predecessors, startNodeId, endNodeId, distances[endNodeId]);
        }

        /**
         * é‡æ„è·¯å¾„ä¿¡æ¯å‡½æ•°
         * æ ¹æ®Dijkstraç®—æ³•è®¡ç®—å‡ºçš„å‰é©±èŠ‚ç‚¹æ•°ç»„ï¼Œé‡æ„å®Œæ•´çš„è·¯å¾„ä¿¡æ¯
         * 
         * @param {Object} graph - åœ°é“ç½‘ç»œå›¾å¯¹è±¡
         * @param {Object} predecessors - å‰é©±èŠ‚ç‚¹æ•°ç»„ï¼Œè®°å½•æœ€çŸ­è·¯å¾„ä¸­æ¯ä¸ªèŠ‚ç‚¹çš„å‰é©±
         * @param {string} startNodeId - èµ·å§‹èŠ‚ç‚¹ID
         * @param {string} endNodeId - ç›®æ ‡èŠ‚ç‚¹ID
         * @param {number} totalDistance - æ€»è·ç¦»
         * @returns {Object} è¿”å›åŒ…å«å®Œæ•´è·¯å¾„ä¿¡æ¯çš„å¯¹è±¡
         */
        function reconstructPath(graph, predecessors, startNodeId, endNodeId, totalDistance) {
            // å­˜å‚¨å®Œæ•´çš„èŠ‚ç‚¹è·¯å¾„ï¼ˆä»èµ·ç‚¹åˆ°ç»ˆç‚¹ï¼‰
            const path = [];
            // ä»ç»ˆç‚¹å¼€å§‹å›æº¯
            let currentNodeId = endNodeId;

            // ========== è·¯å¾„å›æº¯é˜¶æ®µ ==========
            // é€šè¿‡å‰é©±èŠ‚ç‚¹æ•°ç»„ï¼Œä»ç»ˆç‚¹å›æº¯åˆ°èµ·ç‚¹ï¼Œæ„å»ºå®Œæ•´è·¯å¾„
            while (currentNodeId) {
                // å°†å½“å‰èŠ‚ç‚¹æ·»åŠ åˆ°è·¯å¾„å¼€å¤´ï¼ˆå› ä¸ºæ˜¯ä»ç»ˆç‚¹å¾€èµ·ç‚¹å›æº¯ï¼‰
                path.unshift(currentNodeId);
                // è·å–å½“å‰èŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹ï¼Œç»§ç»­å›æº¯
                currentNodeId = predecessors[currentNodeId];
            }

            // ========== ä¿¡æ¯æå–é˜¶æ®µ ==========
    
            // lines: å­˜å‚¨æ¶‰åŠçš„çº¿è·¯ç¼–å·
            const lines = [];
            // transferStations: å­˜å‚¨æ¢ä¹˜ç«™ç‚¹åç§°
            const transferStations = [];

            // éå†å®Œæ•´è·¯å¾„ï¼Œæå–å„ç§ä¿¡æ¯
            path.forEach((nodeId, index) => {
                // è·å–å½“å‰èŠ‚ç‚¹çš„è¯¦ç»†ä¿¡æ¯
                const node = graph[nodeId];

                // è®°å½•ä½¿ç”¨çš„çº¿è·¯ï¼ˆé¿å…é‡å¤æ·»åŠ åŒä¸€çº¿è·¯ï¼‰
                if (!lines.includes(node.line)) {
                    //debugger
                    lines.push(node.line);
                }

                // æ£€æµ‹æ¢ä¹˜ç«™ç‚¹
                if (index > 0) {
                    // è·å–å‰ä¸€ä¸ªèŠ‚ç‚¹
                    const prevNode = graph[path[index - 1]];
                    // å¦‚æœå‰ä¸€ä¸ªèŠ‚ç‚¹å’Œå½“å‰èŠ‚ç‚¹å±äºä¸åŒçº¿è·¯ï¼Œè¯´æ˜å‘ç”Ÿäº†æ¢ä¹˜
                    // ä¼˜åŒ–ï¼šå¦‚æœå½“å‰èŠ‚ç‚¹æ˜¯ç»ˆç‚¹ï¼Œä¸è®¡å…¥æ¢ä¹˜ç«™
                    if (prevNode.line !== node.line && index !== path.length - 1) {
                        // å°†å½“å‰ç«™ç‚¹æ ‡è®°ä¸ºæ¢ä¹˜ç«™ç‚¹
                        transferStations.push(node.station);
                    }
                }
            });

           
            // route: å­˜å‚¨å®Œæ•´çš„ç«™ç‚¹åç§°åºåˆ—
            const route = getFullRoute(graph, path[0], path[path.length - 1], predecessors);

            // ========== ç»“æœå°è£…é˜¶æ®µ ==========
            // æ ¹æ®æ€»è·ç¦»è®¡ç®—ç¥¨ä»·
            const price = calculatePrice(totalDistance);

            // ä¼˜åŒ–è·¯å¾„è¾“å‡ºï¼šåœ¨æ¢ä¹˜èŠ‚ç‚¹ååŠ ä¸Šæ¢ä¹˜å›¾æ ‡
            let routeWithTransferIcon = [];
            for (let i = 0; i < route.length; i++) {
                routeWithTransferIcon.push(route[i]);
                // å¦‚æœå½“å‰ç«™ç‚¹æ˜¯æ¢ä¹˜ç«™ç‚¹ï¼Œåˆ™åŠ ä¸Šå›¾æ ‡
                if (transferStations.includes(route[i])) {
                    routeWithTransferIcon[routeWithTransferIcon.length - 1] += 'ğŸ”„';
                }
            }

            // è¿”å›å®Œæ•´çš„è·¯å¾„ä¿¡æ¯å¯¹è±¡
            return {
                distance: totalDistance,        // æ€»è·ç¦»ï¼ˆå…¬é‡Œï¼‰
                route: routeWithTransferIcon,  // ç«™ç‚¹åºåˆ—ï¼ˆå¸¦æ¢ä¹˜å›¾æ ‡ï¼‰
                lines: lines,                  // æ¶‰åŠçš„çº¿è·¯
                transferStations: transferStations,  // æ¢ä¹˜ç«™ç‚¹
                price: price
            };
        }

         // ä¼˜åŒ–è·¯å¾„å›æº¯ï¼Œç¡®ä¿routeä¸ºå®Œæ•´è·¯å¾„
        // ç”±äºpredecessorså¯èƒ½å› æ¢ä¹˜ç­‰åŸå› ä¸¢å¤±éƒ¨åˆ†èŠ‚ç‚¹ï¼Œè¿™é‡Œé‡‡ç”¨BFSæ–¹å¼ä»èµ·ç‚¹åˆ°ç»ˆç‚¹é‡æ–°éå†graphï¼Œç¡®ä¿è·¯å¾„å®Œæ•´
        function getFullRoute(graph, startNodeId, endNodeId, predecessors) {
            // å…ˆç”¨predecessorså›æº¯å‡ºèŠ‚ç‚¹åºåˆ—
            let nodePath = [];
            let current = endNodeId;
            while (current) {
                nodePath.unshift(current);
                current = predecessors[current];
            }
            // å¦‚æœåªæœ‰ä¸€ä¸ªèŠ‚ç‚¹æˆ–ä¸ºç©ºï¼Œç›´æ¥è¿”å›
            if (nodePath.length <= 1) return nodePath.map(id => graph[id].station);

            // é‡æ–°éå†ï¼Œè¡¥å…¨ä¸­é—´ç¼ºå¤±çš„èŠ‚ç‚¹ï¼ˆå¦‚åŒä¸€çº¿è·¯ä¸Šè¢«è·³è¿‡çš„ç«™ç‚¹ï¼‰
            let fullRoute = [];
            for (let i = 0; i < nodePath.length - 1; i++) {
                const from = nodePath[i];
                const to = nodePath[i + 1];
                const fromNode = graph[from];
                const toNode = graph[to];
                // å¦‚æœæ˜¯åŒä¸€çº¿è·¯ï¼Œä¸”æœ‰ç›´æ¥ç›¸é‚»å…³ç³»ï¼Œè¡¥å…¨ä¸­é—´ç«™ç‚¹
                if (fromNode.line === toNode.line) {
                    // è·å–è¯¥çº¿è·¯æ‰€æœ‰ç«™ç‚¹
                    let stations;
                    if (fromNode.line === '1') stations = line1Stations;
                    else if (fromNode.line === '2') stations = line2Stations;
                    else if (fromNode.line === '3') stations = line3Stations;
                    // æ‰¾åˆ°fromå’Œtoåœ¨è¯¥çº¿è·¯çš„ç´¢å¼•
                    const idxFrom = stations.indexOf(fromNode.station);
                    const idxTo = stations.indexOf(toNode.station);
                    if (idxFrom !== -1 && idxTo !== -1) {
                        // æ–¹å‘ï¼šæ­£å‘æˆ–åå‘
                        const step = idxTo > idxFrom ? 1 : -1;
                        for (let k = idxFrom; k !== idxTo; k += step) {
                            fullRoute.push(stations[k]);
                        }
                    } else {
                        // æ‰¾ä¸åˆ°ç´¢å¼•ï¼Œç›´æ¥åŠ from
                        fullRoute.push(fromNode.station);
                    }
                } else {
                    // æ¢ä¹˜ï¼Œç›´æ¥åŠ from
                    fullRoute.push(fromNode.station);
                }
            }
            // æœ€ååŠ ä¸Šç»ˆç‚¹
            fullRoute.push(graph[nodePath[nodePath.length - 1]].station);

            // å»é‡ï¼ˆé˜²æ­¢å› æ¢ä¹˜é‡å¤ï¼‰
            let dedupedRoute = [];
            for (let s of fullRoute) {
                if (dedupedRoute.length === 0 || dedupedRoute[dedupedRoute.length - 1] !== s) {
                    dedupedRoute.push(s);
                }
            }
            return dedupedRoute;
        }


        // ç„¶åï¼Œæ›¿æ¢åŸæœ‰çš„findShortestPathå‡½æ•°
        function findShortestPath(startInfo, endInfo) {
            const { line: startLine, station: startStation } = startInfo;
            const { line: endLine, station: endStation } = endInfo;

            // æ„å»ºå›¾å¹¶æ·»åŠ æ¢ä¹˜è¿æ¥
            const graph = buildMetroGraph();
            addTransferConnections(graph);
            // ä½¿ç”¨Dijkstraç®—æ³•æŸ¥æ‰¾æœ€çŸ­è·¯å¾„
            var result = dijkstra(graph, startLine, startStation, endLine, endStation);
            return result;
        }
        // è®¡ç®—è´¹ç”¨ä¸»å‡½æ•°
        function calculateFare() {
            const startInfo = selectedStations.start;
            const endInfo = selectedStations.end;
            const resultDiv = document.getElementById('result');

            if (!startInfo.station || !endInfo.station) {
                alert('è¯·å®Œæ•´é€‰æ‹©èµ·å§‹ç«™ç‚¹å’Œç›®çš„ç«™ç‚¹ï¼');
                return;
            }

            if (startInfo.station === endInfo.station) {
                resultDiv.innerHTML = `
                    <h3>ğŸš« èµ·ç‚¹å’Œç»ˆç‚¹ç›¸åŒ</h3>
                    <p>è¯·é€‰æ‹©ä¸åŒçš„èµ·å§‹ç«™ç‚¹å’Œç›®çš„ç«™ç‚¹ã€‚</p>
                `;
                resultDiv.style.display = 'block';
                return;
            }

            const result = findShortestPath(startInfo, endInfo);

            if (!result) {
                resultDiv.innerHTML = `
                    <h3>âŒ æ— æ³•æ‰¾åˆ°è·¯å¾„</h3>
                    <p>ä» <strong>${startInfo.station}</strong> åˆ° <strong>${endInfo.station}</strong> æš‚æ— å¯è¾¾è·¯å¾„ã€‚</p>
                `;
                resultDiv.style.display = 'block';
                return;
            }

            let routeInfo = '';
            if (result.transferStations.length > 0) {
                routeInfo = `
                    <div class="route-info">
                        <h4>ğŸ”„ æ¢ä¹˜è·¯çº¿</h4>
                        <p><strong>è·¯å¾„ï¼š</strong>${result.route.join(' â†’ ')}</p>
                        <p><strong>æ¢ä¹˜ç«™ï¼š</strong>${result.transferStations.join(', ')}</p>
                        <p><strong>æ¶‰åŠçº¿è·¯ï¼š</strong>
                            <span class="line-badge line-${result.lines[0]}">${result.lines[0]}å·çº¿</span>
                            <span class="line-badge line-${result.lines[1]}">${result.lines[1]}å·çº¿</span>
                        </p>
                    </div>
                `;
            } else {
                const lineClass = result.lines[0] === '1' ? 'line-1' : result.lines[0] === '2' ? 'line-2' : 'line-3';
                routeInfo = `
                    <div class="route-info">
                        <h4>ğŸš‡ ç›´è¾¾è·¯çº¿</h4>
                        <p><strong>çº¿è·¯ï¼š</strong><span class="line-badge ${lineClass}">${result.lines[0]}å·çº¿</span></p>
                        <p><strong>è·¯å¾„ï¼š</strong>${result.route.join(' â†’ ')}</p>
                    </div>
                `;
            }

            resultDiv.innerHTML = `
                <h3>ğŸ’° è´¹ç”¨è®¡ç®—ç»“æœ</h3>
                <div style="display: flex; justify-content: space-between; align-items: center; margin: 20px 0;">
                    <div style="font-size: 24px; font-weight: bold;">
                        ç¥¨ä»·ï¼š<span style="color: #fff; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">${result.price}å…ƒ</span>
                    </div>
                    <div style="font-size: 18px;">
                        è·ç¦»ï¼š<span style="color: #fff;">${result.distance.toFixed(2)}å…¬é‡Œ</span>
                    </div>
                </div>
                ${routeInfo}
                <div style="margin-top: 15px; padding: 10px; background: rgba(255,255,255,0.2); border-radius: 5px; font-size: 14px;">
                    <strong>ä»</strong> ${startInfo.station} <strong>åˆ°</strong> ${endInfo.station}
                </div>
            `;
            resultDiv.style.display = 'block';
        }
    </script>
</body>

</html>